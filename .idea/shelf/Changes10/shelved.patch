Index: .idea/workspace.xml
===================================================================
diff --git a/.idea/workspace.xml b/.idea/workspace.xml
deleted file mode 100644
--- a/.idea/workspace.xml	(revision 4e39382b44e9514a71ed4d05e7f832ec6f692d45)
+++ /dev/null	(revision 4e39382b44e9514a71ed4d05e7f832ec6f692d45)
@@ -1,121 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<project version="4">
-  <component name="AutoImportSettings">
-    <option name="autoReloadType" value="SELECTIVE" />
-  </component>
-  <component name="ChangeListManager">
-    <list default="true" id="9a3f6905-9b3d-4761-9387-94c8c3a9766b" name="Changes" comment="">
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/client/ProductsClient.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/config/DevFlywayReset.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/config/HttpClientsConfig.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/config/PaymentsProperties.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/controller/PaymentController.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/domain/Payment.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/domain/PaymentStatus.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/dto/PaymentDto.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/repository/PaymentRepository.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/java/org/example/service/PaymentService.java" afterDir="false" />
-      <change afterPath="$PROJECT_DIR$/src/main/resources/db/migration/V2__add_payments.sql" afterDir="false" />
-      <change beforePath="$PROJECT_DIR$/.idea/shelf/Changes.xml" beforeDir="false" />
-      <change beforePath="$PROJECT_DIR$/.idea/shelf/Changes1.xml" beforeDir="false" />
-      <change beforePath="$PROJECT_DIR$/.idea/shelf/Changes2.xml" beforeDir="false" />
-      <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/workspace.xml" afterDir="false" />
-      <change beforePath="$PROJECT_DIR$/src/main/java/org/example/exception/RestExceptionHandler.java" beforeDir="false" afterPath="$PROJECT_DIR$/src/main/java/org/example/exception/RestExceptionHandler.java" afterDir="false" />
-      <change beforePath="$PROJECT_DIR$/src/main/resources/application.yaml" beforeDir="false" afterPath="$PROJECT_DIR$/src/main/resources/application.yaml" afterDir="false" />
-    </list>
-    <option name="SHOW_DIALOG" value="false" />
-    <option name="HIGHLIGHT_CONFLICTS" value="true" />
-    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
-    <option name="LAST_RESOLUTION" value="IGNORE" />
-  </component>
-  <component name="FileTemplateManagerImpl">
-    <option name="RECENT_TEMPLATES">
-      <list>
-        <option value="Interface" />
-        <option value="Class" />
-      </list>
-    </option>
-  </component>
-  <component name="Git.Settings">
-    <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$" />
-  </component>
-  <component name="GitHubPullRequestSearchHistory">{
-  &quot;lastFilter&quot;: {
-    &quot;state&quot;: &quot;OPEN&quot;,
-    &quot;assignee&quot;: &quot;VioletNeon&quot;
-  }
-}</component>
-  <component name="GithubPullRequestsUISettings">{
-  &quot;selectedUrlAndAccountId&quot;: {
-    &quot;url&quot;: &quot;https://github.com/VioletNeon/hw-db-connection.git&quot;,
-    &quot;accountId&quot;: &quot;f1d1cb20-6e24-4a30-a0b8-a190a8f7b976&quot;
-  }
-}</component>
-  <component name="ProjectColorInfo">{
-  &quot;associatedIndex&quot;: 4
-}</component>
-  <component name="ProjectId" id="31GpIZcmkFKRFIOzkLp228PXZ29" />
-  <component name="ProjectViewState">
-    <option name="autoscrollFromSource" value="true" />
-    <option name="hideEmptyMiddlePackages" value="true" />
-    <option name="showLibraryContents" value="true" />
-  </component>
-  <component name="PropertiesComponent"><![CDATA[{
-  "keyToString": {
-    "Application.Main.executor": "Run",
-    "ModuleVcsDetector.initialDetectionPerformed": "true",
-    "RunOnceActivity.ShowReadmeOnStart": "true",
-    "git-widget-placeholder": "HW7",
-    "onboarding.tips.debug.path": "/Users/violetneon/IdeaProjects/hw-db-connection/src/main/java/org/example/Main.java"
-  }
-}]]></component>
-  <component name="RecentsManager">
-    <key name="CopyClassDialog.RECENTS_KEY">
-      <recent name="org.example.repository" />
-    </key>
-  </component>
-  <component name="RunManager">
-    <configuration name="Main" type="Application" factoryName="Application" temporary="true" nameIsGenerated="true">
-      <option name="MAIN_CLASS_NAME" value="org.example.Main" />
-      <module name="hw-db-connection" />
-      <extension name="coverage">
-        <pattern>
-          <option name="PATTERN" value="org.example.domain.*" />
-          <option name="ENABLED" value="true" />
-        </pattern>
-      </extension>
-      <method v="2">
-        <option name="Make" enabled="true" />
-      </method>
-    </configuration>
-    <recent_temporary>
-      <list>
-        <item itemvalue="Application.Main" />
-      </list>
-    </recent_temporary>
-  </component>
-  <component name="TaskManager">
-    <task active="true" id="Default" summary="Default task">
-      <changelist id="9a3f6905-9b3d-4761-9387-94c8c3a9766b" name="Changes" comment="" />
-      <created>1755160184869</created>
-      <option name="number" value="Default" />
-      <option name="presentableId" value="Default" />
-      <updated>1755160184869</updated>
-    </task>
-    <servers />
-  </component>
-  <component name="UnknownFeatures">
-    <option featureType="com.intellij.fileTypeFactory" implementationName="docker-compose.yaml" />
-  </component>
-  <component name="Vcs.Log.Tabs.Properties">
-    <option name="TAB_STATES">
-      <map>
-        <entry key="MAIN">
-          <value>
-            <State />
-          </value>
-        </entry>
-      </map>
-    </option>
-  </component>
-</project>
\ No newline at end of file
Index: src/main/resources/application.yaml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>spring:\n  profiles:\n    active: dev\n\n  main:\n    web-application-type: servlet\n\n  datasource:\n    url: jdbc:postgresql://localhost:5433/pgsdb\n    username: pgsuser\n    password: pgspw\n\n  jpa:\n    hibernate:\n      ddl-auto: validate\n    show-sql: true\n    properties:\n      hibernate.format_sql: true\n      hibernate.highlight_sql: true\n\n  output.ansi.enabled: always\n\n  flyway:\n    enabled: true\n    locations: classpath:db/migration\n    clean-disabled: false\n    default-schema: public\n\npayments:\n  products-base-url: \"http://localhost:${sever.port}/api/products\"\n  http:\n    connect-timeout-ms: 1500\n    read-timeout-ms: 2500\n\nlogging:\n  level:\n    org.hibernate.SQL: debug\n    org.hibernate.orm.jdbc.bind: trace\n\nserver:\n  port: 8080\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/application.yaml b/src/main/resources/application.yaml
--- a/src/main/resources/application.yaml	(revision 4e39382b44e9514a71ed4d05e7f832ec6f692d45)
+++ b/src/main/resources/application.yaml	(date 1757338386361)
@@ -26,12 +26,54 @@
     clean-disabled: false
     default-schema: public
 
-payments:
+products:
   products-base-url: "http://localhost:${sever.port}/api/products"
   http:
     connect-timeout-ms: 1500
     read-timeout-ms: 2500
 
+limits:
+  default: 10000.00
+
+resilience4j:
+  retry:
+    instances:
+      products:
+        max-attempts: 3
+        wait-duration: 200ms
+        retry-exceptions:
+          - org.springframework.web.client.ResourceAccessException
+          - org.springframework.web.client.HttpServerErrorException
+        ignore-exceptions:
+          - org.springframework.web.client.HttpClientErrorException
+  circuitbreaker:
+    instances:
+      products:
+        sliding-window-size: 10
+        failure-rate-threshold: 50
+        wait-duration-in-open-state: 10s
+        permitted-number-of-calls-in-half-open-state: 3
+
+management:
+  endpoints:
+    web:
+      exposure:
+        include: health,info,metrics,prometheus,circuitbreakers,retries
+  endpoint:
+    health:
+      show-details: always
+  metrics:
+    export:
+      prometheus:
+        enabled: true
+
+springdoc:
+  swagger-ui:
+    enabled: true
+    path: /swagger-ui.html
+  api-docs:
+    path: /v3/api-docs
+
 logging:
   level:
     org.hibernate.SQL: debug
Index: src/main/resources/application-dev.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/application-dev.yml b/src/main/resources/application-dev.yml
new file mode 100644
--- /dev/null	(date 1757338407593)
+++ b/src/main/resources/application-dev.yml	(date 1757338407593)
@@ -0,0 +1,5 @@
+products:
+  base-url: "http://localhost:8080/__products_stub/api/products"
+  http:
+    connect-timeout-ms: 2000
+    read-timeout-ms: 3000
Index: src/main/resources/db/migration/V3__add_limits.sql
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/db/migration/V3__add_limits.sql b/src/main/resources/db/migration/V3__add_limits.sql
new file mode 100644
--- /dev/null	(date 1757338432263)
+++ b/src/main/resources/db/migration/V3__add_limits.sql	(date 1757338432263)
@@ -0,0 +1,17 @@
+-- СЕКВЕНС для лимитов
+create sequence if not exists limit_seq start with 1 increment by 50;
+
+-- Таблица лимитов на день
+create table if not exists limits (
+    id         bigint primary key,
+    client_id  bigint not null,
+    day        date   not null,
+    remaining  numeric(19,2) not null,
+    version    bigint not null default 0
+);
+
+-- На одного клиента в один день — одна запись
+create unique index if not exists ux_limits_client_day on limits(client_id, day);
+
+-- Быстрый поиск по клиенту
+create index if not exists ix_limits_client on limits(client_id);
Index: src/main/resources/db/migration/V4__payments_external_id.sql
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/db/migration/V4__payments_external_id.sql b/src/main/resources/db/migration/V4__payments_external_id.sql
new file mode 100644
--- /dev/null	(date 1757338456521)
+++ b/src/main/resources/db/migration/V4__payments_external_id.sql	(date 1757338456521)
@@ -0,0 +1,7 @@
+-- Внешний ид платёжа для идемпотентности
+alter table payments add column if not exists external_id varchar(64);
+
+-- Уникальность повторов: допускаем null, но если не null — то уникален
+create unique index if not exists ux_pay_external
+    on payments(external_id)
+    where external_id is not null;
